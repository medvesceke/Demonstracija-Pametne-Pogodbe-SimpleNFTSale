<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <title>Simple NFT Sale - Demonstracija</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h1, h2 { color: #333; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #45a049; }
        input[type="number"] { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #output { margin-top: 20px; padding: 10px; border: 1px solid #eee; background-color: #f9f9f9; white-space: pre-wrap; }
        .section { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Demonstracija Pametne Pogodbe: SimpleNFTSale</h1>
        
        <p>Preverite, da ste povezani z ustreznim omre쬵em (npr. Sepolia) z MetaMaska.</p>

        <div class="section">
            <h2>丘뙖잺 Konfiguracija Pogodbe</h2>
            <p>Ta polja nastavite glede na to, kam ste pogodbo uvedli.</p>
            <label for="contractAddress">Naslov Pogodbe:</label>
            <input type="text" id="contractAddress" size="42" value="0x... (vstavite naslov pogodbe)">
        </div>

        <div class="section">
            <h2>游늵 Stanje NFT-ja</h2>
            <button onclick="getInfo()">Prika쬴 Trenutno Stanje (getInfo)</button>
            <div id="outputInfo">캛akam na podatke...</div>
        </div>

        <div class="section">
            <h2>游눯 Prodajalec (Lastnik Pogodbe)</h2>
            <p>Za izvedbo transakcij morate biti povezani kot Lastnik pogodbe.</p>
            
            <label for="tokenIdInput">ID 쬰tona (NFT ID):</label>
            <input type="number" id="tokenIdInput" value="1">
            <button onclick="mintCar()">1. Skovanje (mintCar)</button>
            
            <br><br>
            <label for="priceWeiInput">Cena (v Wei):</label>
            <input type="number" id="priceWeiInput" value="1000000000000000000"> 
            <button onclick="setForSale()">2. Daj naprodaj (setForSale)</button>
        </div>

        <div class="section">
            <h2>游눶 Kupec</h2>
            <p>Za nakup se preklopite na drug naslov v MetaMasku, ki ima dovolj ETH.</p>
            <button onclick="buyNFT()">3. Kupi (buy) - Potreben ETH v "Value"</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        // 1. Nastavitev ABI in naslova pogodbe
        const contractABI = [
            // Samo potrebne funkcije za vmesnik: mintCar, setForSale, buy, getInfo, ownerOf (캜e je potrebna)
            { "inputs": [ { "internalType": "uint256", "name": "_tokenId", "type": "uint256" } ], "name": "mintCar", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [ { "internalType": "uint256", "name": "_price", "type": "uint256" } ], "name": "setForSale", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "buy", "outputs": [], "stateMutability": "payable", "type": "function" },
            { "inputs": [], "name": "getInfo", "outputs": [ { "internalType": "uint256", "name": "_id", "type": "uint256" }, { "internalType": "address", "name": "_owner", "type": "address" }, { "internalType": "uint256", "name": "_price", "type": "uint256" }, { "internalType": "bool", "name": "_forSale", "type": "bool" } ], "stateMutability": "view", "type": "function" }
            // Dodajte celoten ABI, 캜e se vam Remix ne zgenerira avtomatsko.
        ];
        
        // Pomo쬹i funkcii za interakcijo
        async function getContract() {
            if (typeof window.ethereum === 'undefined') {
                log('NAPAKA: Prosimo, namestite MetaMask (ali podoben Ethereum ponudnik).', true);
                return null;
            }
            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();
            const contractAddress = document.getElementById('contractAddress').value;
            
            if (!contractAddress || contractAddress.length < 42 || !contractAddress.startsWith('0x')) {
                log('NAPAKA: Prosimo, vnesite veljaven naslov pogodbe.', true);
                return null;
            }
            
            return new ethers.Contract(contractAddress, contractABI, signer);
        }

        function log(message, isError = false) {
            const outputDiv = document.getElementById('output');
            const color = isError ? 'red' : 'green';
            outputDiv.innerHTML += `<p style="color: ${color};"><strong>[${new Date().toLocaleTimeString()}]</strong> ${message}</p>`;
        }

        // FUNKCIJE POGODBE
        
        async function getInfo() {
            const contract = await getContract();
            if (!contract) return;

            try {
                const [id, owner, price, forSale] = await contract.getInfo();
                
                const ethPrice = ethers.formatEther(price);
                const resultText = `
                    NFT ID: ${id.toString()}
                    Trenutni lastnik: ${owner}
                    Cena: ${ethPrice} ETH (${price.toString()} Wei)
                    Naprodaj?: ${forSale ? 'DA' : 'NE'}
                `;
                document.getElementById('outputInfo').innerText = resultText;
                log('Stanje uspe코no pridobljeno.');
                
            } catch (error) {
                log(`NAPAKA pri klicanju getInfo: ${error.message || error}`, true);
            }
        }
        
        async function mintCar() {
            const contract = await getContract();
            if (!contract) return;
            const tokenId = document.getElementById('tokenIdInput').value;

            try {
                log(`Za캜enjam transakcijo 'mintCar' za ID ${tokenId}...`);
                const tx = await contract.mintCar(tokenId);
                await tx.wait();
                log(`Uspe코no skovano! Transakcija: ${tx.hash}`);
                getInfo();
            } catch (error) {
                log(`NAPAKA pri mintCar: ${error.message || error}`, true);
            }
        }
        
        async function setForSale() {
            const contract = await getContract();
            if (!contract) return;
            const priceWei = document.getElementById('priceWeiInput').value;

            try {
                log(`Za캜enjam transakcijo 'setForSale' s ceno ${ethers.formatEther(priceWei)} ETH...`);
                const tx = await contract.setForSale(priceWei);
                await tx.wait();
                log(`Uspe코no nastavljeno za prodajo! Transakcija: ${tx.hash}`);
                getInfo();
            } catch (error) {
                log(`NAPAKA pri setForSale: ${error.message || error}`, true);
            }
        }

        async function buyNFT() {
            const contract = await getContract();
            if (!contract) return;

            try {
                // Najprej pridobi ceno iz pogodbe
                const [, , price] = await contract.getInfo();
                const ethValue = price.toString();

                log(`Za캜enjam transakcijo 'buy' s pla캜ilom ${ethers.formatEther(ethValue)} ETH...`);
                
                const tx = await contract.buy({ value: ethValue });
                await tx.wait();
                
                log(`Uspe코en nakup! Transakcija: ${tx.hash}`);
                getInfo();
            } catch (error) {
                log(`NAPAKA pri buy: ${error.message || error}`, true);
                log("Preverite: 1. Ste preklopili na ra캜un Kupca? 2. Ste vnesli pravilno ceno?", true);
            }
        }

    </script>
</body>
</html>